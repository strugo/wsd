{% extends "base.html" %}
{% load i18n %}

{% block extra_js %}
{% comment %}
<script type="text/javascript">

    var start_x = 20;
    var start_y = 20;
    var chips = {};

    $(document).ready(
            function() {
                load_game_status();
                start_comet_channel();
            });

    function load_game_status() {
        $.post("{% url domino_load_game_status rook.pk %}", function(data) {
            if(data['status'] == 1) {
                $('#status').html('{% trans "started" %}');
            } else {
                $('#status').html('{% trans "not started" %}');
            }

            for (var chip in data['chips']) {
                draw_chip(data['chips'][chip]);
            }
        });
    }

    function draw_chip(chip) {
        var left = chip[0];
        var right = chip[1];
        var prev = chip[3];
        var angle = 0;
        var x = start_x;
        var y = start_y;
        if (left == right) {
            angle = 1;
        }

        if (chips.length > 0) {
            prev = chips[prev];
            if (prev[1] == right) {
                angle = 2;
            }
            if
        }
    }
</script>
{% endcomment %}
    <script src="/static/js/json2.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
    <script src="/static/orbited/Orbited.js"></script>
    <script>
        // set the orbited settings and port
        Orbited.settings.port = {{ ORBITED.port }};
        Orbited.settings.hostname = "{{ ORBITED.host }}";
        //Orbited.settings.streaming = false;
        TCPSocket = Orbited.TCPSocket
    </script>
    <script> document.domain = document.domain; </script>
    <script src="/static/orbited/protocols/stomp/stomp.js"></script>

    <script type="text/javascript" charset="utf-8">

        var my_id = {{ request.user.pk }};
        //var my_turn = false;
        var my_turn = false;
        var table = {};
        var my_selected_chip = null;
        var table_selected_chip = null;

        var start_x = 350;
        var start_y = 300;

        var users = {};

        jQuery(document).ajaxSend(function(event, xhr, settings) {
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function sameOrigin(url) {
            // url could be relative or scheme relative or absolute
            var host = document.location.host; // host + port
            var protocol = document.location.protocol;
            var sr_origin = '//' + host;
            var origin = protocol + sr_origin;
            // Allow absolute or scheme relative URLs to same origin
            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                // or any other URL that isn't scheme relative or absolute i.e relative.
                !(/^(\/\/|http:|https:).*/.test(url));
        }
        function safeMethod(method) {
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    });

    function HiddenChip(angle) {
        this.angle = angle;
        this.get_html = function() {
            var self = this;
            $obj = $('<div class="hidden_chip_'+this.angle+'">&nbsp;</div>');
            return $obj[0];
        }
        return this;
    }

    function Chip(id, left, right) {
        //Temporary chip object
        this.id = id;
        this.left = left;
        this.right = right;
        this.angle = 0;
        this.next = null;
        this.prev = null;

        this.on_table = false;

        this.get_html = function () {
            var self = this;
            if (self.on_table) {
                if ((self.angle == 0) || (self.angle == 1)) {
                    $obj = $('<div class="chip_'+this.angle+'">');
                    $obj.append($('<img src="/static/images/value_'+this.angle+'_'+this.left+'.png">'));
                    $obj.append($('<img src="/static/images/value_'+this.angle+'_'+this.right+'.png"></div>'));
                    $obj.attr('id', 'chip_'+self.id);
                } else {
                    $obj = $('<div class="chip_'+this.angle+'">');
                    $obj.append($('<img src="/static/images/value_'+(this.angle-2)+'_'+this.right+'.png">'));
                    $obj.append($('<img src="/static/images/value_'+(this.angle-2)+'_'+this.left+'.png"></div>'));
                    $obj.attr('id', 'chip_'+self.id);
                }
            } else {
                $obj = $('<div class="chip_'+this.angle+' my_chip">');
                $obj.append($('<img src="/static/images/value_'+this.angle+'_'+this.left+'.png">'));
                $obj.append($('<img src="/static/images/value_'+this.angle+'_'+this.right+'.png"></div>'));
                $obj.attr('id', 'chip_'+self.id);
            }

            $obj.click(function () {
                if (!my_turn) {
                    // not my turn
                    return;
                }

                if (self.on_table == true) {
                    if (my_selected_chip) {
                        if (self.next) {
                            return;
                        }

                        if ((self.left != my_selected_chip.left) && (self.left != my_selected_chip.right)
                                && (self.right != my_selected_chip.left) && (self.right != my_selected_chip.right)) {
                            return;
                        }

                        table_selected_chip = self;
                        process_turn();
                    }
                } else {
                    if (my_selected_chip) {
                        $('#chip_'+my_selected_chip.id).removeClass('my_selected');
                    }
                    $('#chip_'+self.id).addClass('my_selected');
                    my_selected_chip = self;
                }
            });

            return $obj[0]
        }

        this.create_on_table = function () {
            this.on_table = true;
            var html = this.get_html()
            $(html).appendTo($('#gamefield'));
        }

        return this;
    }

    $(document).ready(function() {
        load_game_status();
        start_comet_channel();
    });

    function start_comet_channel() {
        stomp = new STOMPClient();
        stomp.onopen = function(){
            //console.log("opening stomp client");
        };
        stomp.onclose = function(c){
            alert('Lost Connection, Code: ' + c);
        };
        stomp.onerror = function(error){
            alert("Error: " + error);
        };
        stomp.onerrorframe = function(frame){
            alert("Error: " + frame.body);
        };
        stomp.onconnectedframe = function(){
            console.log("Connected. Subscribing");
            //alert("subscribing");
            stomp.subscribe("/{{ room.comet_id }}");
        };
        stomp.onmessageframe = function(frame){
            data = $.parseJSON(frame.body);
            console.log(data);
            switch (data.action) {
                case ('ping'): {
                    break;
                }
                case ('game_start'): {
                    break;
                }
                case ('game_end'): {
                    break;
                }
                case ('delete_chip'): {
                    break;
                }
                case ('place_chip'): {
                    break;
                }
                case ('chat_message'): {
                    break;
                }
                case ('user_out'): {
                    break;
                }
                case ('new_user_chip'): {
                    break;
                }
                case ('new_turn'): {
                    break;
                }
            }
            $('#chip_'+data.chip.chip_id).remove();
            var chip = new Chip(data.chip.chip_id, data.chip.left, data.chip.right);
            console.log(chip);
            chip.create_on_table();
        };
        stomp.connect('{{ STOMP.host }}', {{ STOMP.port }});

    }

    function load_game_status() {
        $.ajax({
            url: '{% url load_game_status room.id %}',
            dataType: 'json',
            success: function (data) {
                if(data['status'] == 1) {
                    $('#status').html('{% trans "started" %}');
                } else {
                    $('#status').html('{% trans "not started" %}');
                }

                console.log(data);
                n = 1;
                $(data.members).each(function (i, e) {
                    if (e.id == my_id) {
                        $("#username_me").html(e.username);
                    } else {
                        //$('#user'+i).text(e.username+' '+ );
                        users[e.id] = i;
                        $("#username_"+n).html(e.username);
                        angle = 1;
                        if (i == 2) {
                            angle = 0;
                        }
                        step = 10;
                        var container = $('#user'+n);
                        for (var k=0;k<e.chips_count;k++) {
                            var chip = HiddenChip(angle);
                            container.append(chip.get_html());
                        }
                        n++;
                    }
                });

                var my_chips = $('#my_chips');
                for (var i in data['my_chips']) {
                    var chip = new Chip(data['my_chips'][i].id, data['my_chips'][i].left, data['my_chips'][i].right);
                    chip.angle = 1;
                    my_chips.append(chip.get_html());
                }
            }
        });
    }

    function process_turn(){
        // Process my turn
        if ((my_selected_chip) && (table_selected_chip)) {
            self.on_table = true;
            var data = {
                chip_id: my_selected_chip.id,
                table_id: table_selected_chip.id
            }
            $.ajax({
                url: '{% url game_step room.id %}',
                type: 'POST',
                dataType: 'json',
                data: data,
                success: function (data) {
                    if (data == 'OK') {
                        $('#chip_'+self.id).remove();
                    } else {
                        $('#chip_'+self.id).removeClass('my_selected');
                    }
                },
                error: function (r) {
                    console.log(r);
                }
            });

        }
        return
    }

    function game_start() {
        $("#status").html('{% trans "Started" %}');
    }

    function count_offset(x, y) {
        var offset = $('#gamefield').offset();
        console.log(offset);
        var data = {
            top: y + offset.top,
            left: x + offset.left
        };
        return data;
    }

    function place_new_chip(left, right, id, prev_id) {
        if (!prev_id) {
            // first chip
            var chip = Chip(id, left, right);
            chip.angle = 1;
            chip.on_table = 1;
            $("#gamefield").append(chip.get_html());
            $("#chip_"+id).offset(count_offset(start_x, start_y));
            table[id] = chip;
        } else {
            var prev = table[prev_id];
            var field_offset = $("#gamefield").offset();
            console.log(prev);
            if (!prev.next) {
                var offset = $("#chip_"+prev_id).offset();
                var angle = 0;
                var dest = 0;
                var chip = Chip(id, left, right);
                if (left == right) {
                    angle = 1;
                }
                if (prev.angle == 1) {
                    if (prev.prev) {
                        if (prev.prev.angle == 0) {
                            angle = 2;
                        }
                    } else {
                        angle = 0;
                    }
                }
                if (angle == 2 ) {
                    if (offset.right - field_offset.right < 50 ){
                        // rotate chip
                        if (table[prev_id].angle == 0) {
                            chip.angle = angle;
                            chip.on_table = true;
                            $("#gamefield").append(chip.get_html());
                            $("#chip_"+id).offset({ top: offset.top-70, right: offset.right});
                        } else {
                            /// rotate chip 180
                            var chip = Chip(id, right, left);
                            chip.angle = angle;
                            chip.on_table = true;
                            $("#gamefield").append(chip.get_html());
                            $("#chip_"+id).offset({ top: offset.top-70, right: offset.right});
                        }
                    } else {
                        chip.angle = angle;
                        chip.on_table = true;
                        $("#gamefield").append(chip.get_html());
                        $("#chip_"+id).offset({ top: offset.top, left: offset.left-70});
                    }
                } else {
                    if (offset.left - field_offset.left < 50 ){
                        // rotate chip
                        if (table[prev_id].angle == 0) {
                            chip.angle = 1;
                            $("#gamefield").append(chip.get_html());
                            $("#chip_"+id).offset({ top: offset.top-70, left: offset.left});
                        } else {
                            /// rotate chip 180
                            var chip = Chip(id, right, left);
                            $("#gamefield").append(chip.get_html());
                            $("#chip_"+id).offset(count_offset(offset.top, offset.left+70));
                        }
                    } else {
                        chip.angle = angle;
                        chip.on_table = true;
                        prev.next = chip;
                        chip.prev = prev;
                    }
                }
                prev.next = chip;
                chip.prev = prev;
                table[id]=chip;
            }
        }
    }

    function delete_chip(id) {
        var chip = $("#chip_"+id);
        if (chip) {
            chip.remove();
        }
    }

    function new_user_chip(user_id) {
        var id = users[user_id]
        var angle = 1
        if (id == 2) angle=0
        var chip = HiddenChip(angle);
        $('#user'+id).append(chip.get_html());
    }

    </script>
{% endblock %}

{% block content %}
    <h1>{% trans "Game" %}: {{ room.pk }} <span id="status"></span></h1>
    <div id="gamemain">
            <div id="user2"><div id="username_2"></div></div>
            <div id="user1"><div id="username_1"></div></div>
            <div id="gamefield"></div>
            <div id="user3"><div id="username_3"></div></div>
            <div id="bank"></div>
            <div id="my_chips"><div id="username_me"></div></div>

            <div id="chat">
                <div id="chat_input"><form action="" onsubmit="send_chat_message()"><input type="text" id="chat_input_string"></form></div>
            </div>

    </div>
{% endblock %}
